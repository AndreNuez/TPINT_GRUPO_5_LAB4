create schema `clinicamedica`;

use `clinicamedica`;


CREATE TABLE `clinicamedica`.`provincias` (
  `IDProvincia` INT NOT NULL AUTO_INCREMENT,
  `Nombre` VARCHAR(45) NOT NULL,
  PRIMARY KEY (`IDProvincia`));


CREATE TABLE `clinicamedica`.`localidades` (
  `IDLocalidad` INT NOT NULL AUTO_INCREMENT,
  `Nombre` VARCHAR(45) NOT NULL,
  `IDProvincia` INT NOT NULL,
  PRIMARY KEY (`IDLocalidad`),
  INDEX `IDProvincia_idx` (`IDProvincia` ASC),
  CONSTRAINT `IDProvincia`
    FOREIGN KEY (`IDProvincia`)
    REFERENCES `clinicamedica`.`provincias` (`IDProvincia`)
    ON DELETE CASCADE
    ON UPDATE NO ACTION);

CREATE TABLE `clinicamedica`.`especialidades` (
  `IDEspecialidad` INT NOT NULL AUTO_INCREMENT,
  `Nombre` VARCHAR(45) NOT NULL,
  PRIMARY KEY (`IDEspecialidad`));


CREATE TABLE `clinicamedica`.`estados` (
  `IDEstado` INT NOT NULL,
  `Nombre` VARCHAR(45) NOT NULL,
  PRIMARY KEY (`IDEstado`));

CREATE TABLE `clinicamedica`.`tiposusuario` (
  `IDTipo` INT NOT NULL,
  `Descripcion` VARCHAR(45) NOT NULL,
  PRIMARY KEY (`IDTipo`));


CREATE TABLE `clinicamedica`.`pacientes` (
  `DNI` INT NOT NULL,
  `Apellido` VARCHAR(45) NOT NULL,
  `Nombres` VARCHAR(45) NOT NULL,
  `Sexo` CHAR(1) NULL,
  `Nacionalidad` VARCHAR(45) NOT NULL,
  `FechaNacimiento` DATE NOT NULL,
  `Mail` VARCHAR(45) NOT NULL,
  `Telefono` VARCHAR(45) NOT NULL,
  `Estado` BIT(1) NOT NULL,
  PRIMARY KEY (`DNI`));


CREATE TABLE `clinicamedica`.`medicos` (
  `DNI` INT NOT NULL,
  `Apellido` VARCHAR(45) NOT NULL,
  `Nombres` VARCHAR(45) NOT NULL,
  `Sexo` CHAR(1) NOT NULL,
  `FechaNacimiento` DATE NOT NULL,
  `Nacionalidad` VARCHAR(45) NOT NULL,
  `Mail` VARCHAR(45) NOT NULL,
  `Telefono` VARCHAR(45) NOT NULL,
  `IDEspecialidad` INT NOT NULL,
  `DiaHorarioAtencion` DATETIME NOT NULL,
  `Estado` BIT(1) NOT NULL,
  PRIMARY KEY (`DNI`));
  
ALTER TABLE `clinicamedica`.`medicos` 
ADD INDEX `IDEspecialidad_idx` (`IDEspecialidad` ASC);

ALTER TABLE `clinicamedica`.`medicos` 
ADD CONSTRAINT `IDEspecialidad`
  FOREIGN KEY (`IDEspecialidad`)
  REFERENCES `clinicamedica`.`especialidades` (`IDEspecialidad`)
  ON DELETE NO ACTION
  ON UPDATE NO ACTION;

CREATE TABLE `clinicamedica`.`turnos` (
  `IDTurno` INT NOT NULL,
  `IDEspecialidad` VARCHAR(45) NOT NULL,
  `FechaHora` DATETIME NOT NULL,
  `DNIMedico` INT NOT NULL,
  `IDEstado` INT NOT NULL,
  `Observacion` VARCHAR(45) NULL,
  PRIMARY KEY (`IDTurno`, `FechaHora`, `DNIMedico`),
  INDEX `IDEstados_idx` (`IDEstado` ASC),
  CONSTRAINT `IDEstados`
    FOREIGN KEY (`IDEstado`)
    REFERENCES `clinicamedica`.`estados` (`IDEstado`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION);

ALTER TABLE `clinicamedica`.`turnos` 
ADD INDEX `FK_DNI_Medicos_idx` (`DNIMedico` ASC);

ALTER TABLE `clinicamedica`.`turnos` 
ADD CONSTRAINT `FK_DNI_Medicos`
  FOREIGN KEY (`DNIMedico`)
  REFERENCES `clinicamedica`.`medicos` (`DNI`)
  ON DELETE NO ACTION
  ON UPDATE NO ACTION;


CREATE TABLE `clinicamedica`.`usuarios` (
  `DNI` INT NOT NULL,
  `IDTipoUsuario` INT NOT NULL,
  `Contrase√±a` VARCHAR(10) NOT NULL,
  PRIMARY KEY (`DNI`),
  INDEX `TipoUsuario_idx` (`IDTipoUsuario` ASC),
  CONSTRAINT `TipoUsuario`
    FOREIGN KEY (`IDTipoUsuario`)
    REFERENCES `clinicamedica`.`tiposusuario` (`IDTipo`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION);

ALTER TABLE `clinicamedica`.`medicos` 
ADD CONSTRAINT `DNIAUsuarios`
  FOREIGN KEY (`DNI`)
  REFERENCES `clinicamedica`.`usuarios` (`DNI`)
  ON DELETE NO ACTION
  ON UPDATE NO ACTION;

ALTER TABLE `clinicamedica`.`turnos` 
ADD COLUMN `DNIPaciente` INT NOT NULL AFTER `DNIMedico`,
ADD INDEX `FK_DNI_Pacientes_idx` (`DNIPaciente` ASC);
ALTER TABLE `clinicamedica`.`turnos` 
ADD CONSTRAINT `FK_DNI_Pacientes`
  FOREIGN KEY (`DNIPaciente`)
  REFERENCES `clinicamedica`.`pacientes` (`DNI`)
  ON DELETE NO ACTION
  ON UPDATE NO ACTION;

ALTER TABLE `clinicamedica`.`turnos` 
DROP FOREIGN KEY `FK_DNI_Pacientes`;
ALTER TABLE `clinicamedica`.`turnos` 
DROP COLUMN `IDEspecialidad`,
CHANGE COLUMN `DNIPaciente` `DNIPaciente` INT(11) NULL DEFAULT NULL ;
ALTER TABLE `clinicamedica`.`turnos` 
ADD CONSTRAINT `FK_DNI_Pacientes`
  FOREIGN KEY (`DNIPaciente`)
  REFERENCES `clinicamedica`.`pacientes` (`DNI`)
  ON DELETE NO ACTION
  ON UPDATE NO ACTION;

ALTER TABLE `clinicamedica`.`medicos` 
DROP COLUMN `DiaHorarioAtencion`,
ADD COLUMN `HoraInicio` TIME(2) NOT NULL AFTER `IDEspecialidad`,
ADD COLUMN `HoraFin` TIME(2) NOT NULL AFTER `HoraInicio`,
ADD COLUMN `DiaAtencion` DATE NOT NULL AFTER `HoraFin`;

ALTER TABLE `clinicamedica`.`medicos` 
DROP COLUMN `DiaAtencion`,
DROP COLUMN `HoraFin`,
DROP COLUMN `HoraInicio`;

CREATE TABLE `clinicamedica`.`horariosxmedicos` (
  `idHorario` INT(11) NOT NULL,
  `DNIMedico` INT(11) NOT NULL,
  `HoraInicio` TIME(2) NOT NULL,
  `HoraFin` TIME(2) NOT NULL,
  `DiaAtencion` VARCHAR(10) NOT NULL,
  PRIMARY KEY (`idHorario`),
  INDEX `DniMedicos_idx` (`DNIMedico` ASC),
  CONSTRAINT `DniMedicos`
    FOREIGN KEY (`DNIMedico`)
    REFERENCES `clinicamedica`.`medicos` (`DNI`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION);

ALTER TABLE `clinicamedica`.`turnos` 
CHANGE COLUMN `Observacion` `Observacion` VARCHAR(200) NULL DEFAULT NULL ;

CREATE TABLE `clinicamedica`.`direccionespacientes` (
  `IDDireccion` VARCHAR(45) NOT NULL,
  `DNI` INT NOT NULL,
  `Calle` VARCHAR(45) NOT NULL,
  `Numero` VARCHAR(45) NOT NULL,
  `IDLocalidad` INT NOT NULL,
  PRIMARY KEY (`IDDireccion`),
  INDEX `FK_DNIPaciente_idx` (`DNI` ASC),
  CONSTRAINT `FK_DNIPaciente`
    FOREIGN KEY (`DNI`)
    REFERENCES `clinicamedica`.`pacientes` (`DNI`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION);

ALTER TABLE `clinicamedica`.`direccionespacientes` 
ADD CONSTRAINT `FK_Localidad`
  FOREIGN KEY (`IDLocalidad`)
  REFERENCES `clinicamedica`.`localidades` (`IDLocalidad`)
  ON DELETE NO ACTION
  ON UPDATE NO ACTION;

ALTER TABLE `clinicamedica`.`direccionespacientes` 
ADD UNIQUE INDEX `DNI_UNIQUE` (`DNI` ASC);

CREATE TABLE `clinicamedica`.`direccionesmedicos` (
  `IDDireccion` INT NOT NULL,
  `DNI` INT NOT NULL,
  `Calle` VARCHAR(45) NOT NULL,
  `Numero` INT NOT NULL,
  `IDLocalidad` INT NOT NULL,
  PRIMARY KEY (`IDDireccion`),
  INDEX `FK_DNIMedico_idx` (`DNI` ASC),
  INDEX `FL_IDLocalidad_idx` (`IDLocalidad` ASC),
  CONSTRAINT `FK_DNIMedico`
    FOREIGN KEY (`DNI`)
    REFERENCES `clinicamedica`.`medicos` (`DNI`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION,
  CONSTRAINT `FL_IDLocalidad`
    FOREIGN KEY (`IDLocalidad`)
    REFERENCES `clinicamedica`.`localidades` (`IDLocalidad`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION);

ALTER TABLE `clinicamedica`.`direccionesmedicos` 
ADD UNIQUE INDEX `DNI_UNIQUE` (`DNI` ASC);

ALTER TABLE `clinicamedica`.`pacientes` 
CHANGE COLUMN `Estado` `Estado` TINYINT(1) NOT NULL ;